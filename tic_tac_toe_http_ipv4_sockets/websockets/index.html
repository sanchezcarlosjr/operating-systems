<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="utf-8" />
		<meta http-equiv="X-UA-Compatible" content="IE=edge" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		<title>Tic Tac Toe</title>
		<link href="https://fonts.googleapis.com/css?family=Lato:300,400,700,900" rel="stylesheet" />
		<link href="https://fonts.googleapis.com/css2?family=Finger+Paint&display=swap" rel="stylesheet">
		<!-- https://github.com/trohalska/Tic-tac-toe -->
		<link rel="stylesheet" href="style.css">
	</head>
	<body>
		<h1 id="title">Tic tac toe by Carlos Eduardo Sanchez Torres</h1>
		<p>Code on <a href="https://github.com/sanchezcarlosjr/operating-systems/tree/main/tic_tac_toe_http_ipv4_sockets">Tic Tac Toe WebSockets Code</a>. Template by https://github.com/trohalska/Tic-tac-toe</p>
		<main>
			<section id="field">
				<div id="container">
					<div id="row=0&column=0" class="cell"></div>
					<div id="row=0&column=1" class="cell"></div>
					<div id="row=0&column=2" class="cell"></div>
					<div id="row=1&column=0" class="cell"></div>
					<div id="row=1&column=1" class="cell"></div>
					<div id="row=1&column=2" class="cell"></div>
					<div id="row=2&column=0" class="cell"></div>
					<div id="row=2&column=1" class="cell"></div>
					<div id="row=2&column=2" class="cell"></div>
				</div>
			</section>
			<section id="sidebar">
				<div id="turns">
					<p id="titleTurns">Number of turns</p>
					<p id="numberTurns">0</p>
				</div>
				<h2 id="status">Connecting to server</h2>
			</section>
		</main>
		<script>
			const movementAudio = new Audio("Swoosh_3_SoundBible-com_1573211927.mp3");
			const winningAudio = new Audio("Auditorium_Applause_SoundBible_com_280911206.mp3");

			let state = "0";
			let symbol = "";
			let uuid = "";
			const machine = {
							"0": "Connecting to server",
							"1": "Waiting an opponent",
							"2": "Move",
							"3": "Wait",
							"4": "Win!",
							"5": "Tie",
							"6": "Lose!",
							"7": "Setting...",
							"8": "Closing connection"
						};
			function newState(newState) {
							state = newState;
							document.getElementById("status").innerHTML = machine[newState];
							if (state === "4") {
								winningAudio.play();
							}
						}
			const protocol = document.location.protocol == "https:" ? "wss" : "ws";
			const socket = new WebSocket(`${protocol}://${document.location.host}`);
			socket.onopen = (event) => newState("1");
			socket.onmessage = (event) => {
							const message = JSON.parse(event.data);
							newState(message.state);
							if (message.state === "7") {
											symbol = message.symbol;
											uuid = message.uuid;
										}	
							if (message.row >= 0 && message.column >= 0) {
											document.getElementById(`row=${message.row}&column=${message.column}`).innerHTML = message.symbol;
											document.getElementById("numberTurns").innerHTML++;
											movementAudio.play();
										}
						}
			socket.onclose = (event) => {
							newState("8");
						};

			function captureRowAndColumn(id) {
							const regex_row_column = /row=([0-8])&column=([0-8])/;
							const matches = id.match(regex_row_column);
							return {
											row: parseInt(matches[1]),
											column: parseInt(matches[2])
										};
						} 
			for(const element of document.getElementsByClassName("cell")) {
							const position = captureRowAndColumn(element.id);
							element.addEventListener('click', async (event) => {
											if (state !== "2" || event.target.innerHTML !== "") {
															return;
														}
											event.target.innerHTML = symbol;
											console.log(position);
											socket.send(JSON.stringify({state, symbol, uuid, ...position}));
											newState("3");
										});
						}
		</script>
	</body>
</html>
